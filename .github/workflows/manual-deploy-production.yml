name: Deploy to Firebase Hosting (Production)

on:
    workflow_dispatch:
        inputs:
            deploy_online:
                description: 'Deploy online (Firebase)'
                type: boolean
                required: true
                default: true
            deploy_offline:
                description: 'Deploy offline (Firebase)'
                type: boolean
                required: true
                default: true
            deploy_netlify:
                description: 'Deploy offline (Netlify)'
                type: boolean
                required: true
                default: true
            version:
                description: 'Version (e.g., v1.0.0)'
                required: true
                default:

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Environment
              uses: ./.github/actions/setup-env
              with:
                  manual_version: ${{ inputs.version }}

            - name: Validate Secrets
              id: check_secrets
              uses: ./.github/actions/validate-secrets
              with:
                  deploy_online: ${{ inputs.deploy_online }}
                  deploy_offline: ${{ inputs.deploy_offline }}
                  deploy_netlify: ${{ inputs.deploy_netlify }}
                  firebase_service_account: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAPLIO }}
                  firebase_api_key: ${{ secrets.VITE_FIREBASE_API_KEY }}
                  firebase_auth_domain: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
                  firebase_project_id: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
                  firebase_storage_bucket: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
                  firebase_messaging_sender_id: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
                  firebase_app_id: ${{ secrets.VITE_FIREBASE_APP_ID }}
                  firebase_service_account_offline: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAPLIO_OFFLINE }}
                  firebase_project_id_offline: ${{ secrets.VITE_FIREBASE_PROJECT_ID_OFFLINE }}
                  netlify_auth_token: ${{ secrets.NETLIFY_AUTH_TOKEN }}
                  netlify_site_id: ${{ secrets.NETLIFY_SITE_ID }}

            # ----------------------------------------------------------------
            # 1. Online Build & Deployment (Firebase)
            # ----------------------------------------------------------------
            - name: Build for Online
              # Execute only if deploy_online is true AND secrets check passed (ONLINE_OK=true)
              if: ${{ inputs.deploy_online == true && steps.check_secrets.outputs.online_ok == 'true' }}
              run: npm run build
              env:
                  VITE_APP_VERSION: ${{ env.APP_VERSION }}
                  # Inject all Firebase environment variables (Used during Build)
                  VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
                  VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
                  VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
                  VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
                  VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
                  VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}

            - name: Online Deploy to Firebase
              if: ${{ inputs.deploy_online == true && steps.check_secrets.outputs.online_ok == 'true' }}
              uses: FirebaseExtended/action-hosting-deploy@v0
              with:
                  repoToken: '${{ secrets.GITHUB_TOKEN }}'
                  firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAPLIO }}'
                  public: dist
                  channelId: live
                  projectId: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
                  message: 'Release ${{ env.APP_VERSION }}'

            - name: Skip Online Deploy
              if: ${{ inputs.deploy_online == true && steps.check_secrets.outputs.online_ok == 'false' }}
              run: |
                  echo "⚠️ Firebase online deployment skipped due to missing secrets."

            # ----------------------------------------------------------------
            # 2. Offline Build & Deployment (Firebase / Netlify / GitHub Release Zip)
            # ----------------------------------------------------------------
            - name: Build for Offline
              run: |
                  npm run build:offline
                  rm -rf dist
                  cp -r dist-offline dist
              env:
                  VITE_APP_MODE: offline
                  VITE_APP_VERSION: ${{ env.APP_VERSION }}

            - name: Offline Deploy to Firebase
              if: ${{ inputs.deploy_offline == true && steps.check_secrets.outputs.offline_ok == 'true' }}
              uses: FirebaseExtended/action-hosting-deploy@v0
              with:
                  repoToken: '${{ secrets.GITHUB_TOKEN }}'
                  firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAPLIO_OFFLINE }}'
                  public: dist-offline
                  channelId: live
                  projectId: ${{ secrets.VITE_FIREBASE_PROJECT_ID_OFFLINE }}
                  message: 'Release Offline ${{ env.APP_VERSION }}'

            - name: Skip Offline Deploy
              if: ${{ inputs.deploy_offline == true && steps.check_secrets.outputs.offline_ok == 'false' }}
              run: |
                  echo "⚠️ Firebase offline deployment skipped due to missing secrets."

            - name: Offline Deploy to Netlify
              if: ${{ inputs.deploy_netlify == true && steps.check_secrets.outputs.netlify_ok == 'true' }}
              uses: nwtgck/actions-netlify@v3.0
              with:
                  publish-dir: './dist-offline'
                  production-branch: main
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  deploy-message: 'Deploy v${{ env.APP_VERSION }} from GitHub Actions'
                  enable-pull-request-comment: false
                  enable-commit-comment: false
                  overwrites-pull-request-comment: false
              env:
                  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
                  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

            - name: Skip Netlify Deploy
              if: ${{ inputs.deploy_netlify == true && steps.check_secrets.outputs.netlify_ok == 'false' }}
              run: echo "⚠️ Netlify offline deployment skipped due to missing secrets."

            - name: Zip Offline Artifact
              run: |
                  cd dist-offline
                  zip -r ../maplio-offline.zip ./*
                  echo "✅ Zip created: maplio-offline.zip"

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ env.APP_VERSION }}
                  name: Release ${{ env.APP_VERSION }}
                  files: maplio-offline.zip
                  draft: false
                  prerelease: false
                  generate_release_notes: true
